QUESTION:
Give me top 150 members based on average monthly visits.

CORRECT QUERY:
SELECT m.memberid AS `Member id`, m.firstname AS `First Name`, m.lastname AS `Last Name`, 
       SUM(mt.transactioncount) AS `Transaction Count`, 
       SUM(mt.transactioncount)/COUNT(DISTINCT DATE_FORMAT(yearmonth, '%Y-%m')) AS `Average Monthly Visits`
FROM members m
JOIN metrics mt ON m.memberid = mt.memberid
GROUP BY m.memberid
ORDER BY `Average Monthly Visits` DESC
LIMIT 150;

=============
QUESTION:
Give me the top member per month.

CORRECT QUERY:
SELECT 
    m.yearmonth AS `Month-Year`,
    mt.memberid AS `Member id`,
    mem.firstname AS `First Name`,
    mem.lastname AS `Last Name`,
    m.sales AS `Total Sales`
FROM (
    SELECT 
        yearmonth,
        memberid,
        sales,
        RANK() OVER (PARTITION BY yearmonth ORDER BY sales DESC) AS sales_rank
    FROM metrics
) m
JOIN members mem ON m.memberid = mem.memberid
JOIN metrics mt ON m.memberid = mt.memberid AND m.yearmonth = mt.yearmonth
WHERE m.sales_rank = 1
GROUP BY m.yearmonth
ORDER BY m.yearmonth
LIMIT 20;